import { useEffect, useState } from 'react';
import Head from 'next/head';
import { useRouter } from 'next/router';
import { BSON } from 'realm-web';
import { MDXRemote } from 'next-mdx-remote';
import { serialize } from 'next-mdx-remote/serialize';
import useRealmStore, { userTypes } from '../../hooks/useRealmStore';
import { Editor } from '../../components/shared/Editor/Editor';
import { Layout } from '../../components/shared/Layout/Layout';
import { components } from '../../components/mdx/allComponents';

const { ObjectId } = BSON;

export default function NotePage() {
	const router = useRouter();
	const { noteId } = router.query;

	const [thisNote, setThisNote] = useState(null);

	const userType = useRealmStore((state) => state.userType);
	const notes = useRealmStore((state) => state.notes);
	const db = useRealmStore((state) => state.db);

	useEffect(() => {
		(async () => {
			const noteFromLocalState =
				notes && notes.find((note) => noteId === note._id.toString());
			if (noteFromLocalState) {
				const serializedContent = await serialize(noteFromLocalState.content);
				setThisNote({ ...noteFromLocalState, content: serializedContent });
			} else {
				if (db) {
					const fetchedNote = await db
						.collection('notes')
						.findOne({ _id: ObjectId(noteId) });
					const serializedContent = await serialize(fetchedNote.content);
					setThisNote({ ...fetchedNote, content: serializedContent });
				}
			}
		})();
	}, [db, notes]); // eslint-disable-line react-hooks/exhaustive-deps

	console.log(thisNote);

	return (
		// albo edytor dla admina lub home layout dla visitor
		<>
			<Head>
				<title>Create Next App</title>
				<meta name="description" content="Generated by create next app" />
				<link rel="icon" href="/favicon.ico" />
			</Head>
			{userType === userTypes.admin ? (
				<Editor />
			) : (
				<>
					{thisNote && (
						<Layout>
							<section>
								<p>Tytu≈Ç: {thisNote.title}</p>
								{console.log(thisNote.content)}
								{thisNote.content && (
									<MDXRemote {...thisNote.content} components={components} />
								)}
							</section>
						</Layout>
					)}
				</>
			)}
		</>
	);
}
