import { useEffect, useState, useCallback } from 'react';
import Head from 'next/head';
import { useRouter } from 'next/router';
import { BSON } from 'realm-web';
import useRealmStore, { userTypes } from '../../hooks/useRealmStore';
import { NoteForVisitor } from '../../components/NotePage/NoteForVisitor/NoteForVisitor';
import { NoteForAdmin } from '../../components/NotePage/NoteForAdmin/NoteForAdmin';
import useNoteStore from '../../hooks/useNoteStore';

const { ObjectId } = BSON;

const statusTypes = {
	success: 'success',
	error: 'error',
	loading: 'loading',
};

export default function NotePage() {
	const router = useRouter();
	let { noteId, title, content, tags: noteTags, isPublic } = router.query;

	if (isPublic === 'true') {
		isPublic = true;
	} else if (isPublic === 'false') {
		isPublic = false;
	}

	if (typeof noteTags === 'string') {
		noteTags = [noteTags];
	}

	const setValues = useNoteStore((state) => state.setValues);
	const clearStore = useNoteStore((state) => state.clearStore);

	const userType = useRealmStore((state) => state.userType);
	const db = useRealmStore((state) => state.db);

	const [status, setStatus] = useState(statusTypes.loading);

	const fetchNoteData = useCallback(async () => {
		try {
			const {
				title,
				content,
				tags: noteTags,
				isPublic,
			} = await db.collection('notes').findOne({ _id: ObjectId(noteId) });
			setValues({
				noteId,
				title,
				content,
				noteTags,
				isPublic,
			});
			setStatus(statusTypes.success);
		} catch (err) {
			console.error(err);
			setStatus(statusTypes.error);
		}
	}, [db, noteId, setValues]);

	useEffect(() => {
		(async () => {
			if (db && !title && !content) {
				await fetchNoteData();
			} else {
				if (userType === userTypes.admin && typeof isPublic !== 'boolean') {
					await fetchNoteData();
				} else {
					setValues({ noteId, title, content, noteTags, isPublic });
					setStatus(statusTypes.success);
				}
			}
		})();
	}, [
		content,
		db,
		fetchNoteData,
		isPublic,
		noteId,
		noteTags,
		router.query,
		setValues,
		title,
		userType,
	]);

	useEffect(() => {
		const exitingFunction = () => clearStore();

		router.events.on('routeChangeStart', exitingFunction);

		return () => {
			router.events.off('routeChangeStart', exitingFunction);
		};
	}, []);

	return (
		<>
			<Head>
				<title>{title}</title>
				<meta name="description" content="Generated by create next app" />
				<link rel="icon" href="/favicon.ico" />
			</Head>
			{status === statusTypes.success ? (
				<>
					{userType === userTypes.admin ? <NoteForAdmin /> : <NoteForVisitor />}
				</>
			) : status === statusTypes.loading ? (
				<p>Loading...</p>
			) : (
				<p>
					Wystąpił błąd przy wyświetleniu notatki. Sprawdź połączenie z
					internetem lub odśwież stronę.
				</p>
			)}
		</>
	);
}
