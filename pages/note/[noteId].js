import { useEffect, useState } from 'react';
import Head from 'next/head';
import { useRouter } from 'next/router';
import { BSON } from 'realm-web';
import useRealmStore, { userTypes } from '../../hooks/useRealmStore';
import { NoteForVisitor } from '../../components/NotePage/NoteForVisitor/NoteForVisitor';
import { NoteForAdmin } from '../../components/NotePage/NoteForAdmin/NoteForAdmin';
import { useNoteStore } from '../../hooks/useNoteStore';

const { ObjectId } = BSON;

export default function NotePage() {
	const router = useRouter();
	const ready = router.isReady;
	let { noteId, title, content, tags, isPublic } = router.query;

	// values from router.query are strings
	if (isPublic === 'true') {
		isPublic = true;
	} else if (isPublic === 'false') {
		isPublic = false;
	}

	if (typeof tags === 'string') {
		tags = [tags];
	}

	const userType = useRealmStore((state) => state.userType);

	const [note, setNote] = useState({
		title,
		content,
		tags,
		isPublic,
	});

	// const {title, content, tags, isPublic} = useNoteStore()

	// if user enter page 'directly' (not through Nextjs Link)
	const db = useRealmStore((state) => state.db);
	useEffect(() => {
		(async () => {
			if (db && !title && !content) {
				let fetchedNote = await db
					.collection('notes')
					.findOne({ _id: ObjectId(noteId) });
				setNote(fetchedNote);
			}
		})();
	}, [db]);

	return (
		<>
			<Head>
				<title>{title}</title>
				<meta name="description" content="Generated by create next app" />
				<link rel="icon" href="/favicon.ico" />
			</Head>
			{ready ? (
				<>
					{userType === userTypes.admin ? (
						<NoteForAdmin {...note} />
					) : (
						<NoteForVisitor {...note} />
					)}
				</>
			) : (
				<p>Loading...</p>
			)}
		</>
	);
}
